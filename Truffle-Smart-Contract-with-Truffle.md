# Testing smart contracts with truffle

Installing truffle

```
npm install -g truffle@beta
```

Create an Auction project

```
mkdir Auction
cd Auction
truffle init
```

We create a smart contract

```
nano contracts/Auction.sol
```

Paste the smart contract code there

```
pragma solidity ^0.4.19;
contract Auction {
  address public manager;
  address public seller;
  uint public latestBid;
  address public latestBidder;
 
  constructor() public {
    manager = msg.sender;
  }
 
  function auction(uint bid) public {
    latestBid = bid * 1 ether; //1000000000000000000;
    seller = msg.sender;
  }
 
  function bid() public payable {
    require(msg.value > latestBid);
 
    if (latestBidder != 0x0) {
      latestBidder.transfer(latestBid);
    }
    latestBidder = msg.sender;
    latestBid = msg.value;
  }
 
  function finishAuction() restricted public {
    seller.transfer(address(this).balance);
  }
 
  modifier restricted() {
    require(msg.sender == manager);
    _;
  }
}
```

Save (`ctrl+o`) and close the file (`ctrl+x`)

We can compile the code to check that everything works

```
truffle compile
```

We write our network in truffle.js

```
module.exports = {
  // See <http://truffleframework.com/docs/advanced/configuration>
  // to customize your Truffle configuration!
  networks: {
    “development”: {
      network_id: 2,
      host: “localhost”,
      port: 9545
    },
  }
};
```

## Run test node
There are several different nodes that differ in performance and solidity in assembler.

> The assembler in the truffle and ganache node is different from the mainnet node, so it's better not to test the code where the assembler is used on them (which in itself is a rare case). For this use geth or parity.

### Ganache

It is best to use Ganache for tests, as it displays the current balance and the number of transactions in real time

Ganache can be downloaded [here](http://truffleframework.com/ganache/)

![](Resources/Ganache.png)

### Truffle и Ganache-cli

There are also terminal nodes from truffle and ganache. In fact, they are no different from each other.

#### To run a truffle node, we write:

```
truffle develop
```

#### Ganache-cli

Install

```
npm install -g ganache-cli
```

Run

```
ganache-cli --port 9545
```


### Writing a test

Create a file `test/Auction.js`

```
// Importing the smart contract interface generated by truffle
const Auction = artifacts.require('Auction');

// We write a test for it
contract('AuctionTests', async(accounts) => {
  let auction;

  // Before each test, create a new contract
  beforeEach(async function () {
    auction = await Auction.new();
  });

  // And the tests themselves
  it('should allow to start auction', async() => {
    await auction.auction('1')
  });
  
  it('should allow to make multiple bids', async() => {
    await auction.auction('1')
    await auction.bid({from: accounts[1], value: '2'});
    await auction.bid({from: accounts[2], value: '3'});
    await auction.bid({from: accounts[1], value: '4'});
    await auction.finishAuction();
  })
  it('should not let non contract owner to finish auction', async() => {
    await auction.auction('1', {from: accounts[1]})
    await auction.bid({from: accounts[1], value: '2'});
    await auction.bid({from: accounts[2], value: '3'});
    await auction.bid({from: accounts[1], value: '4'});
    await assertRevert(auction.finishAuction({from: accounts[1]}));
    await assertRevert(auction.finishAuction({from: accounts[2]}));
    await assertRevert(auction.finishAuction({from: accounts[5]}));
    await auction.finishAuction({from: accounts[0]});
  });
  it('should finish auction with only one bid', async() => {
    await auction.auction('100');
    await auction.bid({from: accounts[1], value: '110'})
    await auction.finishAuction();
  })
  it('should revert when bidding less than previous bid', async() => {
    await auction.auction('100');
    await assertRevert(auction.bid({value: '99'}));
  })
})

async function assertRevert (promise) {
    try {
        await promise;
    } catch (error) {
        const revertFound = error.message.search('revert') >= 0;
        assert(revertFound, `Expected "revert", got ${error} instead`);
        return;
    }
    assert.fail('Expected revert not received');
}
```

### Run the test

```
truffle test
```

## Resources
1) https://trufflesuite.com/
2) https://github.com/trufflesuite/truffle
3) https://github.com/v57/TruffleTestsGuide/tree/master
